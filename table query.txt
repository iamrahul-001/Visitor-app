-- Drop objects if they exist (in reverse dependency order)
DROP TRIGGER VISITORS_TRG;
DROP SEQUENCE VISITORS_SEQ;
DROP INDEX IDX_VISITORS_PLANNED;
DROP INDEX IDX_VISITORS_CURRENT;
DROP INDEX IDX_VISITORS_TYPE;
DROP INDEX IDX_VISITORS_TIME_IN;
DROP TABLE VISITORS;

-- Create VISITORS table with DATE columns
CREATE TABLE VISITORS (
    VISITOR_ID NUMBER PRIMARY KEY,
    FULL_NAME VARCHAR2(100) NOT NULL,
    PERSON_TO_MEET VARCHAR2(100) NOT NULL,
    PURPOSE_OF_VISIT VARCHAR2(100) NOT NULL,
    PHONE_NUMBER VARCHAR2(20) NOT NULL,
    TIME_IN DATE,
    TIME_OUT DATE,
    VISITOR_PHOTO_PATH VARCHAR2(255),
    VISITOR_TYPE CHAR(1) DEFAULT 'N' NOT NULL CHECK (VISITOR_TYPE IN ('N', 'P')),
    PLANNED_DATE DATE
);

-- Create sequence for auto-increment
CREATE SEQUENCE VISITORS_SEQ
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- Create trigger for auto-increment
CREATE OR REPLACE TRIGGER VISITORS_TRG
BEFORE INSERT ON VISITORS
FOR EACH ROW
BEGIN
    IF :NEW.VISITOR_ID IS NULL THEN
        SELECT VISITORS_SEQ.NEXTVAL INTO :NEW.VISITOR_ID FROM DUAL;
    END IF;
END;
/

-- Create indexes
CREATE INDEX IDX_VISITORS_PLANNED ON VISITORS (VISITOR_TYPE, PLANNED_DATE);
CREATE INDEX IDX_VISITORS_CURRENT ON VISITORS (TIME_OUT);
CREATE INDEX IDX_VISITORS_TYPE ON VISITORS (VISITOR_TYPE);
CREATE INDEX IDX_VISITORS_TIME_IN ON VISITORS (TIME_IN);